<!DOCTYPE html>
<html>
  <head>
    <title>Superchargers.io</title>
    <link rel="icon" type="image/x-icon" href="/favicon.png">
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,600" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
    <style>
      body {
        font-family: 'Roboto', sans-serif;
      }
      header {
        background: rgba(255, 255, 255, 0.75);
        border-bottom: 1px solid rgba(255, 255, 255, 0.25);
        position: absolute;
        z-index: 100;
        top: 0;
        width: 100%;
        height: 50px;
        font-size: 13px;
      }
      header h1 {
        float: left;
        margin: 0 0 0 25px;
      }
      header ul {
        margin: 16px 0 0;
        padding: 0;
        float: right;
      }
      header li {
        float: left;
        list-style: none;
        margin-right: 25px;
        font-weight: 600;
        letter-spacing: 1px;
      }
      a {
        color: #000;
      }
      .marker {
        background-image: url("/assets/icon-supercharger@2x.png");
        background-size: 23px 33px;
        width: 23px;
        height: 33px;
      }
      footer {
        background: rgba(0, 0, 0, 0.75);
        border-top: 1px solid rgba(255, 255, 255, 0.25);
        position: absolute;
        z-index: 100;
        bottom: 0;
        width: 100%;
        height: 50px;
      }
      .mapboxgl-ctrl-bottom-right {
        bottom: 50px;
      }
      #map {
          position:absolute;
          top:0;
          bottom:0;
          width:100%;
      }
      #form {
        background: rgba(255, 255, 255, 0.5);
        position: absolute;
        z-index: 100;
        top: 75px;
        left: 25px;
        width: 25%;
        bottom: 75px;
        border-radius: 5px;
        border: 0;
        font: 14px/1.5em Consolas, "Liberation Mono", Menlo, Courier, monospace;
        outline: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1><a href="/">Superchargers.io</a></h1>
      <ul>
        <li><a href="/graphiql">GraphiQL</a></li>
        <li><a href="https://github.com/wattapp/superchargers">GitHub</a></li>
      </ul>
    </header>
    <textarea id="form">{
  locations(country: UNITED_STATES, first: 100) {
    edges {
      location:node {
        id
        address
        latitude
        longitude
        title
      }
    }
  }
}
    </textarea>
    <div id="map">
    </div>
    <footer>
      Hi!
    </footer>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ2FycmV0dGJqZXJraG9lbCIsImEiOiJjaXQyNGZvNWgwc25hMnBwZzQyaTg5YzJpIn0.2y2NliHBXJaiLCPkWcTkYg';
    var markers = [];
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v9',
        zoom: 3,
        center: [-98.585522, 39.8333333]
    });

    var buildHTML = function(location) {
      if(location === undefined) {
        return "Unknown location"
      }

      body = ""
      for(item in location) {
        body += `<li>${item}: ${location[item]}</li>`
      }

      return `
      ${location.title}
      <ul>
        ${body}
      </ul>
      `
    }

    document.getElementById('form').onchange = function (e) {
      fetch("/graphql", {
        method: "POST",
        body: this.value,
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/graphql"
        }
      }).then(function(response) {
        if(response.ok) {
          return response.json().then(function(json) {
            markers.forEach(function(marker) {
              marker.remove()
            })
            var coordinates = json.data.locations.edges.map(function(node) {
              return [node.location.longitude, node.location.latitude]
            });

            markers = []
            json.data.locations.edges.forEach(function(node) {
                // create DOM element for the marker
                var el = document.createElement('div');
                el.className = 'marker';

                var popup = new mapboxgl.Popup().setHTML(buildHTML(node.location))

                // create the marker
                var marker = new mapboxgl.Marker(el, {offset: [-12, 5]})
                    .setLngLat([node.location.longitude, node.location.latitude])
                    .setPopup(popup)
                    .addTo(map)

                markers.push(marker)
            })

            if(coordinates.length > 1) {
              var bounds = coordinates.reduce(function(bounds, coord) {
                  return bounds.extend(coord);
              }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));

              map.fitBounds(bounds, {
                  padding: 50
              });
            }
          })
        } else {
          console.log('Network response was not ok.');
        }
      })
      .catch(function(error) {
        console.log('There has been a problem with your fetch operation: ' + error.message);
      });
    }

    window.onload = function(){
      document.getElementById('form').onchange()
    }
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-86725414-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
